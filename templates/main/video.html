{% extends 'main/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ video.title }} - KRONIK{% endblock %}

{% block content %}
<div class="video-page-layout">
    <div class="video-content">
        {% csrf_token %}
        <div class="video-container" data-video-id="{{ video.gcs_id }}" data-user-id="{{ video.user_id }}">
            <div class="video-wrapper">
                <video id="video-player" poster="{% if video.thumbnail_url %}{{ video.thumbnail_url }}{% else %}{% static 'placeholder.jpg' %}{% endif %}" preload="metadata">
                    <!-- Video source will be added dynamically via JavaScript -->
                </video>
                
                <div class="video-overlays">
                    <div class="top-controls">
                        <div class="video-title">{{ video.title }}</div>
                        <div class="kronik-logo">
                            <div class="logo-icon">K</div>
                            <span>KRONIK</span>
                        </div>
                    </div>
                    
                    <div class="overlay-bottom-controls">
                        <div class="progress-container" id="progress-container">
                            <div class="buffer-bar" id="buffer-bar"></div>
                            <div class="progress-bar" id="progress-bar">
                                <div class="progress-handle"></div>
                            </div>
                        </div>
                        
                        <div class="controls-row">
                            <div class="left-controls">
                                <button class="control-button" id="play-pause-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                                    </svg>
                                </button>
                                
                                <div class="volume-container">
                                    <button class="control-button" id="volume-btn">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="currentColor"/>
                                            <path d="M19.07 4.93C20.91 6.77 22 9.27 22 12C22 14.73 20.91 17.23 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            <path d="M15.54 8.46C16.47 9.39 17 10.62 17 12C17 13.38 16.47 14.61 15.54 15.54" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    
                                    <div class="volume-slider">
                                        <div class="volume-bar" id="volume-bar">
                                            <div class="volume-level" id="volume-level"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="time-display">
                                    <span id="current-time">0:00</span>
                                    <span>/</span>
                                    <span id="duration">{{ video.duration|default:"0:00" }}</span>
                                </div>
                            </div>
                            
                            <div class="right-controls">
                                <button class="control-button" id="pip-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="2" y="4" width="20" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <rect x="14" y="11" width="6" height="5" rx="1" fill="currentColor"/>
                                    </svg>
                                </button>
                                
                                <button class="control-button" id="fullscreen-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 8V4H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M4 16V20H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M20 8V4H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M20 16V20H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                
                                <button class="control-button" id="settings-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM12 14C10.9 14 10 13.1 10 12C10 10.9 10.9 10 12 10C13.1 10 14 10.9 14 12C14 13.1 13.1 14 12 14Z" fill="currentColor"/>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.88 3.5L14.38 6.06C14.95 6.29 15.48 6.61 15.95 7L18.41 6.11L20.29 9.39L18.11 10.95C18.11 11.3 18.11 11.65 18.11 12C18.11 12.35 18.11 12.7 18.11 13.05L20.29 14.61L18.41 17.89L15.95 17C15.48 17.39 14.95 17.71 14.38 17.94L13.88 20.5H10.12L9.62 17.94C9.05 17.71 8.52 17.39 8.05 17L5.59 17.89L3.71 14.61L5.89 13.05C5.89 12.7 5.89 12.35 5.89 12C5.89 11.65 5.89 11.3 5.89 10.95L3.71 9.39L5.59 6.11L8.05 7C8.52 6.61 9.05 6.29 9.62 6.06L10.12 3.5H13.88ZM12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8Z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="play-big-button visible" id="play-big-btn">
                    <div class="play-icon"></div>
                </div>
                
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div class="settings-menu" id="settings-menu">
                <div class="settings-item" id="playback-speed-item">
                    <span>Скорость воспроизведения</span>
                    <span id="current-speed">1x</span>
                </div>
                
                <div class="playback-speed-options" id="playback-speed-options">
                    <div class="speed-option" data-speed="0.25">0.25x</div>
                    <div class="speed-option" data-speed="0.5">0.5x</div>
                    <div class="speed-option" data-speed="0.75">0.75x</div>
                    <div class="speed-option active" data-speed="1">1x</div>
                    <div class="speed-option" data-speed="1.25">1.25x</div>
                    <div class="speed-option" data-speed="1.5">1.5x</div>
                    <div class="speed-option" data-speed="1.75">1.75x</div>
                    <div class="speed-option" data-speed="2">2x</div>
                </div>
                
                <div class="settings-item" id="quality-item">
                    <span>Качество</span>
                    <span id="current-quality">авто</span>
                </div>
                
                <div class="quality-options" id="quality-options">
                    <div class="quality-option auto-quality active" data-quality="auto">
                        <span class="quality-label">авто</span>
                        <span class="quality-badge">AI</span>
                    </div>
                    <!-- Quality options will be added dynamically via JavaScript -->
                </div>
                
                <div class="settings-item" id="loop-item">
                    <span>Повтор</span>
                    <span id="loop-status">Выкл</span>
                </div>
            </div>

            <div class="quality-change-overlay" id="quality-change-overlay">
                <div class="quality-change-spinner"></div>
                <div class="quality-change-text">Изменение качества...</div>
            </div>
        </div>

        <div class="video-details">
            <h1>{{ video.title }}</h1>
            <div class="video-info-bar">
                <div class="views-info">{{ video.views_formatted }} • {{ video.upload_date_formatted|default:video.age }}</div>
                <div class="actions-bar">
                    <button class="action-button" id="likeButton">
                        <img src="{% static 'icons/like.svg' %}" alt="Like" width="20" height="20">
                        <span id="likeCount">{{ video.likes|default:"0" }}</span>
                    </button>
                    <button class="action-button" id="dislikeButton">
                        <img src="{% static 'icons/dislike.svg' %}" alt="Dislike" width="20" height="20">
                        <span id="dislikeCount">{{ video.dislikes|default:"0" }}</span>
                    </button>
                    <button class="action-button" id="shareButton">
                        <img src="{% static 'icons/share.svg' %}" alt="Share" width="20" height="20">
                        Поделиться
                    </button>
                </div>
            </div>
            
            <div class="channel-info">
                <a href="{% url 'channel' username=video.user_id %}" class="avatar avatar-large">
                    {% if video.avatar_url %}
                        <img src="{{ video.avatar_url }}" alt="{{ video.display_name|default:video.channel }}" loading="lazy">
                    {% else %}
                        <span class="avatar-text">{{ video.display_name|first|default:video.channel|first }}</span>
                    {% endif %}
                </a>
                <div class="channel-details">
                    <a href="{% url 'channel' username=video.user_id %}" class="channel-name">{{ video.display_name|default:video.channel }}</a>
                    <div class="subscribers"><span id="subscriber-count">{{ video.subscribers|default:"0" }}</span> подписчиков</div>
                </div>
                {% if user.is_authenticated and user.username != video.user_id %}
                <button class="subscribe-button" data-channel-id="{{ video.user_id }}">Подписаться</button>
                {% elif not user.is_authenticated %}
                <button class="subscribe-button" onclick="showLoginPrompt()">Подписаться</button>
                {% endif %}
            </div>
            
            <div class="video-description">
                <p>{{ video.description|default:"Описание видео отсутствует." }}</p>
            </div>
        </div>

        <div class="unsubscribe-dialog" id="unsubscribe-dialog">
            <div class="unsubscribe-dialog-content">
                <h3>Отписаться от канала</h3>
                <p>Вы точно хотите отписаться от автора <strong id="unsubscribe-channel-name">{{ video.display_name|default:video.channel }}</strong>?</p>
                <div class="unsubscribe-dialog-buttons">
                    <button id="confirm-unsubscribe" class="confirm-unsubscribe-btn">Отписаться</button>
                    <button id="cancel-unsubscribe" class="cancel-unsubscribe-btn">Отмена</button>
                </div>
            </div>
        </div>
                
        <div class="qa-section">
            <h2>Вопросы и обсуждение</h2>
            <div class="comment-form" id="qa-form">
                <div class="avatar">
                    {% if user.is_authenticated %}
                        {% if user_avatar_url %}
                            <img src="{{ user_avatar_url }}" alt="{{ user.profile.display_name|default:user.username }}" loading="lazy">
                        {% else %}
                            <span class="avatar-text">{% if user.profile.display_name %}{{ user.profile.display_name|first }}{% else %}{{ user.username|first }}{% endif %}</span>
                        {% endif %}
                    {% else %}
                        <span class="avatar-text">Г</span>
                    {% endif %}
                </div>
                <input type="text" id="qa-input" placeholder="{% if user.is_authenticated %}Задайте вопрос или оставьте комментарий...{% else %}Войдите, чтобы задать вопрос{% endif %}" {% if not user.is_authenticated %}disabled{% endif %}>
                <button id="qa-submit" class="qa-submit" {% if not user.is_authenticated %}disabled{% endif %}>Отправить</button>
            </div>
            
            {% if not user.is_authenticated %}
            <div class="login-prompt">
                <p>Чтобы оставлять вопросы и комментарии, необходимо <a href="{% url 'login' %}">войти</a> или <a href="{% url 'register' %}">зарегистрироваться</a>.</p>
            </div>
            {% endif %}
            
            <div class="qa-list" id="qa-list">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="qa-item" data-comment-id="{{ comment.id }}" data-user-id="{{ comment.user_id }}">
                        <div class="avatar {% if comment.user_id == video.user_id %}author-avatar{% endif %}">
                            {% if comment.avatar_url %}
                                <img src="{{ comment.avatar_url }}" alt="{{ comment.display_name }}" loading="lazy">
                            {% else %}
                                <span class="avatar-text">{{ comment.display_name|first }}</span>
                            {% endif %}
                        </div>
                        <div class="qa-content">
                            <div class="qa-author {% if comment.user_id == video.user_id %}is-author{% endif %}" data-username="{{ comment.user_id }}">
                                {{ comment.display_name }} 
                                {% if comment.user_id == video.user_id %}<span class="author-badge">Автор</span>{% endif %}
                            </div>
                            <div class="qa-text">{{ comment.text }}</div>
                            <div class="qa-meta">{{ comment.date|date:"d.m.Y" }}</div>
                            <div class="qa-actions">
                                <button class="qa-like" data-liked="false"><img src="/static/icons/like.svg" alt="Like" width="20" height="20"> <span>{{ comment.likes|default:"0" }}</span></button>
                                <button class="qa-reply-btn" data-comment-id="{{ comment.id }}">Ответить</button>
                            </div>
                            
                            <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                                <div class="avatar">
                                    {% if user.is_authenticated %}
                                        {% if user_avatar_url %}
                                            <img src="{{ user_avatar_url }}" alt="{{ user.profile.display_name|default:user.username }}" loading="lazy">
                                        {% else %}
                                            <span class="avatar-text">{% if user.profile.display_name %}{{ user.profile.display_name|first }}{% else %}{{ user.username|first }}{% endif %}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="avatar-text">Г</span>
                                    {% endif %}
                                </div>
                                <input type="text" id="reply-input-{{ comment.id }}" placeholder="{% if user.is_authenticated %}Ответить на вопрос...{% else %}Войдите, чтобы ответить{% endif %}" {% if not user.is_authenticated %}disabled{% endif %}>
                                <button class="reply-submit" data-comment-id="{{ comment.id }}" {% if not user.is_authenticated %}disabled{% endif %}>Ответить</button>
                                <button class="cancel-reply" data-comment-id="{{ comment.id }}">Отмена</button>
                            </div>
                            
                            {% if comment.replies %}
                                <button class="show-replies-btn" data-shown="false">Показать ответы ({{ comment.replies|length }})</button>
                                <div class="qa-replies" style="display: none;">
                                    {% for reply in comment.replies %}
                                    <div class="qa-reply" data-user-id="{{ reply.user_id }}">
                                        <div class="avatar {% if reply.user_id == video.user_id %}author-avatar{% endif %}">
                                            {% if reply.avatar_url %}
                                                <img src="{{ reply.avatar_url }}" alt="{{ reply.display_name }}" loading="lazy">
                                            {% else %}
                                                <span class="avatar-text">{{ reply.display_name|first }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="qa-content">
                                            <div class="qa-author {% if reply.user_id == video.user_id %}is-author{% endif %}" data-username="{{ reply.user_id }}">
                                                {{ reply.display_name }}
                                                {% if reply.user_id == video.user_id %}<span class="author-badge">Автор</span>{% endif %}
                                            </div>
                                            <div class="qa-text">{{ reply.text }}</div>
                                            <div class="qa-meta">{{ reply.date|date:"d.m.Y" }}</div>
                                            <div class="qa-actions">
                                                <button class="qa-like"><img src="/static/icons/like.svg" alt="Like" width="20" height="20"> <span>{{ reply.likes|default:"0" }}</span></button>
                                                <button class="qa-reply-to-reply-btn" data-comment-id="{{ comment.id }}" data-username="{{ reply.user_id }}">Ответить</button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="qa-replies"></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-qa">
                        <div class="avatar">К</div>
                        <div class="qa-content">
                            <div class="qa-author">KRONIK</div>
                            <div class="qa-text">Пока никто не задал вопрос. Будьте первым!</div>
                            <div class="qa-meta">Только что</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="related-videos">
        <h3>Рекомендуемые видео</h3>
        <div class="related-videos-list" id="related-videos-container">
            {% if recommended_videos %}
                {% for video in recommended_videos %}
                <div class="related-video-card" onclick="window.location.href='{{ video.url }}'">
                    <div class="related-thumbnail">
                        {% if video.thumbnail_url %}
                        <img src="{{ video.thumbnail_url }}" alt="{{ video.title }}" loading="lazy" onerror="this.src='{% static 'placeholder.jpg' %}'">
                        {% else %}
                        <img src="{% static 'placeholder.jpg' %}" alt="{{ video.title }}" loading="lazy">
                        {% endif %}
                    </div>
                    <div class="related-info">
                        <div class="related-title">{{ video.title }}</div>
                        <div class="related-channel">{{ video.display_name|default:video.channel }}</div>
                        <div class="related-stats">{{ video.views_formatted }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="padding: 20px; color: var(--gray-color); text-align: center;">Рекомендации загружаются...</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Common avatar styles */
.avatar {
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--accent-color);
    color: white;
    font-weight: bold;
    flex-shrink: 0;
    text-decoration: none;
    transition: transform 0.3s;
}

.avatar:hover {
    transform: scale(1.05);
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-text {
    font-size: 0.6em;
    text-transform: uppercase;
}

.avatar-large {
    width: 50px;
    height: 50px;
}

.avatar-small {
    width: 24px;
    height: 24px;
}

.avatar-medium {
    width: 40px;
    height: 40px;
}

.author-avatar {
    background-color: #ffd700;
    color: #000;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

/* Action button styles */
.action-button {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px 15px;
    background-color: rgba(159, 37, 88, 0.1);
    border: none;
    border-radius: 20px;
    color: var(--text-light);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
}

.action-button:hover {
    background-color: rgba(159, 37, 88, 0.2);
    transform: translateY(-2px);
}

.action-button.active {
    background-color: var(--accent-color);
    color: white;
}

.action-button.active img {
    filter: brightness(0) invert(1);
}

/* Channel info styles */
.channel-info {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-top: 1px solid rgba(159, 37, 88, 0.1);
    border-bottom: 1px solid rgba(159, 37, 88, 0.1);
    margin: 15px 0;
}

.channel-details {
    flex-grow: 1;
}

.channel-details .channel-name {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 5px;
    color: rgba(159, 37, 88, 0.8);
    text-decoration: none;
    transition: color 0.3s;
}

.dark-theme .channel-details .channel-name {
    color: rgba(255, 176, 201, 0.9);
}

.channel-details .channel-name:hover {
    color: var(--primary-color);
    text-decoration: underline;
}

.subscribers {
    font-size: 14px;
    color: var(--gray-color);
}

.subscribe-button {
    padding: 10px 20px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 30px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.subscribe-button:hover {
    background-color: #7d1e46;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(159, 37, 88, 0.3);
}

.subscribe-button.subscribed {
    background-color: #333;
}

/* Login prompt */
.login-prompt {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--light-bg);
    border-radius: 15px;
    padding: 20px 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    text-align: center;
    z-index: 1000;
    display: none;
}

.dark-theme .login-prompt {
    background-color: var(--medium-bg);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.login-prompt a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: bold;
}

.login-prompt a:hover {
    text-decoration: underline;
}

.login-prompt-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 999;
    display: none;
}

.login-prompt.show, .login-prompt-backdrop.show {
    display: block;
}

.login-prompt .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 20px;
    color: var(--gray-color);
    cursor: pointer;
}

.login-prompt .close-btn:hover {
    color: var(--primary-color);
}

/* Unsubscribe dialog */
.unsubscribe-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.unsubscribe-dialog.active {
    opacity: 1;
    visibility: visible;
}

.unsubscribe-dialog-content {
    background-color: var(--light-bg);
    border-radius: 15px;
    padding: 25px;
    max-width: 90%;
    width: 450px;
    text-align: center;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.dark-theme .unsubscribe-dialog-content {
    background-color: var(--medium-bg);
}

.unsubscribe-dialog h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
}

.unsubscribe-dialog p {
    margin-bottom: 20px;
    line-height: 1.5;
}

.unsubscribe-dialog-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
}

.confirm-unsubscribe-btn, .cancel-unsubscribe-btn {
    padding: 10px 20px;
    border-radius: 30px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.confirm-unsubscribe-btn {
    background-color: #ff4757;
    color: white;
    border: none;
    box-shadow: 0 3px 10px rgba(255, 71, 87, 0.3);
}

.confirm-unsubscribe-btn:hover {
    background-color: #e3263c;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
}

.cancel-unsubscribe-btn {
    background-color: transparent;
    color: var(--text-dark);
    border: 2px solid var(--gray-color);
}

.dark-theme .cancel-unsubscribe-btn {
    color: var(--text-light);
}

.cancel-unsubscribe-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateY(-3px);
}
</style>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/kronik-player.js' %}"></script>
<script src="{% static 'js/quality-change.js' %}"></script>
<script src="{% static 'js/qa-comments.js' %}"></script>
<script src="{% static 'js/video-sharing.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButton = document.getElementById('likeButton');
    const dislikeButton = document.getElementById('dislikeButton');
    const likeCount = document.getElementById('likeCount');
    const dislikeCount = document.getElementById('dislikeCount');
    const videoContainer = document.querySelector('.video-container');
    const videoPlayer = document.getElementById('video-player');
    const viewsInfo = document.querySelector('.views-info');

    if (!videoContainer || !likeButton || !dislikeButton || !videoPlayer || !viewsInfo) {
        console.error('Required elements not found');
        return;
    }

    const videoId = videoContainer.getAttribute('data-video-id');
    const userId = videoContainer.getAttribute('data-user-id');
    const compositeId = `${userId}__${videoId}`;
    let isLiked = false;
    let isDisliked = false;
    let viewTracked = false;
    let watchStartTime = null;

    let sessionId = localStorage.getItem('session_id');
    if (!sessionId) {
        sessionId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        localStorage.setItem('session_id', sessionId);
    }

    function createLoginPrompt() {
        const loginPrompt = document.createElement('div');
        loginPrompt.className = 'login-prompt';
        loginPrompt.innerHTML = `
            <button class="close-btn">×</button>
            <h3>Требуется авторизация</h3>
            <p>Чтобы оценить видео, необходимо <a href="/login/?next=/video/${compositeId}/">войти</a> или <a href="/register/">зарегистрироваться</a>.</p>
        `;
        const backdrop = document.createElement('div');
        backdrop.className = 'login-prompt-backdrop';
        document.body.appendChild(loginPrompt);
        document.body.appendChild(backdrop);

        const closeBtn = loginPrompt.querySelector('.close-btn');
        closeBtn.addEventListener('click', function() {
            loginPrompt.classList.remove('show');
            backdrop.classList.remove('show');
        });
        backdrop.addEventListener('click', function() {
            loginPrompt.classList.remove('show');
            backdrop.classList.remove('show');
        });

        return { loginPrompt, backdrop };
    }

    const { loginPrompt, backdrop } = createLoginPrompt();

    function showLoginPrompt() {
        loginPrompt.classList.add('show');
        backdrop.classList.add('show');
    }

    fetch(`/api/video-like-status/${compositeId}/?user_id=${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                isLiked = data.is_liked;
                isDisliked = data.is_disliked;
                likeButton.classList.toggle('active', isLiked);
                dislikeButton.classList.toggle('active', isDisliked);
                console.log('Like status loaded:', { isLiked, isDisliked });
            } else {
                console.error('Error fetching like status:', data.error);
            }
        })
        .catch(error => console.error('Error fetching like status:', error));

    likeButton.addEventListener('click', function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const currentLikes = parseInt(likeCount.textContent);
        const currentDislikes = parseInt(dislikeCount.textContent);
        const previousIsLiked = isLiked;
        const previousIsDisliked = isDisliked;

        if (isLiked) {
            isLiked = false;
            likeButton.classList.remove('active');
            likeCount.textContent = Math.max(0, currentLikes - 1);
        } else {
            isLiked = true;
            likeButton.classList.add('active');
            likeCount.textContent = currentLikes + 1;
            if (isDisliked) {
                isDisliked = false;
                dislikeButton.classList.remove('active');
                dislikeCount.textContent = Math.max(0, currentDislikes - 1);
            }
        }

        const formData = new FormData();
        formData.append('video_id', compositeId);
        formData.append('user_id', userId);

        fetch('/api/toggle-video-like/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                likeCount.textContent = data.likes;
                dislikeCount.textContent = data.dislikes;
                isLiked = data.is_liked;
                isDisliked = data.is_disliked;
                likeButton.classList.toggle('active', isLiked);
                dislikeButton.classList.toggle('active', isDisliked);
                console.log('Like toggled:', { likes: data.likes, dislikes: data.dislikes });
            } else if (data.require_login) {
                isLiked = previousIsLiked;
                isDisliked = previousIsDisliked;
                likeButton.classList.toggle('active', previousIsLiked);
                dislikeButton.classList.toggle('active', previousIsDisliked);
                likeCount.textContent = currentLikes;
                dislikeCount.textContent = currentDislikes;
                showLoginPrompt();
            } else {
                console.error('Error toggling like:', data.error);
                isLiked = previousIsLiked;
                isDisliked = previousIsDisliked;
                likeButton.classList.toggle('active', previousIsLiked);
                dislikeButton.classList.toggle('active', previousIsLiked);
                likeCount.textContent = currentLikes;
                dislikeCount.textContent = currentDislikes;
            }
        })
        .catch(error => {
            console.error('Error toggling like:', error);
            isLiked = previousIsLiked;
            isDisliked = previousIsDisliked;
            likeButton.classList.toggle('active', previousIsLiked);
            dislikeButton.classList.toggle('active', previousIsDisliked);
            likeCount.textContent = currentLikes;
            dislikeCount.textContent = currentDislikes;
        });
    });

    dislikeButton.addEventListener('click', function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const currentLikes = parseInt(likeCount.textContent);
        const currentDislikes = parseInt(dislikeCount.textContent);
        const previousIsLiked = isLiked;
        const previousIsDisliked = isDisliked;

        if (isDisliked) {
            isDisliked = false;
            dislikeButton.classList.remove('active');
            dislikeCount.textContent = Math.max(0, currentDislikes - 1);
        } else {
            isDisliked = true;
            dislikeButton.classList.add('active');
            dislikeCount.textContent = currentDislikes + 1;
            if (isLiked) {
                isLiked = false;
                likeButton.classList.remove('active');
                likeCount.textContent = Math.max(0, currentLikes - 1);
            }
        }

        const formData = new FormData();
        formData.append('video_id', compositeId);
        formData.append('user_id', userId);

        fetch('/api/toggle-video-dislike/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                likeCount.textContent = data.likes;
                dislikeCount.textContent = data.dislikes;
                isLiked = data.is_liked;
                isDisliked = data.is_disliked;
                likeButton.classList.toggle('active', isLiked);
                dislikeButton.classList.toggle('active', isDisliked);
                console.log('Dislike toggled:', { likes: data.likes, dislikes: data.dislikes });
            } else if (data.require_login) {
                isLiked = previousIsLiked;
                isDisliked = previousIsDisliked;
                likeButton.classList.toggle('active', previousIsLiked);
                dislikeButton.classList.toggle('active', previousIsDisliked);
                likeCount.textContent = currentLikes;
                dislikeCount.textContent = currentDislikes;
                showLoginPrompt();
            } else {
                console.error('Error toggling dislike:', data.error);
                isLiked = previousIsLiked;
                isDisliked = previousIsDisliked;
                likeButton.classList.toggle('active', previousIsLiked);
                dislikeButton.classList.toggle('active', previousIsDisliked);
                likeCount.textContent = currentLikes;
                dislikeCount.textContent = currentDislikes;
            }
        })
        .catch(error => {
            console.error('Error toggling dislike:', error);
            isLiked = previousIsLiked;
            isDisliked = previousIsDisliked;
            likeButton.classList.toggle('active', previousIsLiked);
            dislikeButton.classList.toggle('active', previousIsDisliked);
            likeCount.textContent = currentLikes;
            dislikeCount.textContent = currentDislikes;
        });
    });

    function trackView() {
        if (viewTracked) {
            console.log('View already tracked for this session');
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        formData.append('video_id', compositeId);
        formData.append('user_id', userId);
        formData.append('session_id', sessionId);

        fetch('/api/track-view/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                viewTracked = true;
                viewsInfo.textContent = `${data.views} views • ${viewsInfo.textContent.split(' • ')[1]}`;
                console.log('View tracked:', { views: data.views, view_counted: data.view_counted });
            } else {
                console.error('Error tracking view:', data.error);
            }
        })
        .catch(error => console.error('Error tracking view:', error));
    }

    const subscribeButton = document.querySelector('.subscribe-button');
    if (subscribeButton) {
        let isSubscribed = false;
        
        subscribeButton.addEventListener('click', function() {
            {% if not user.is_authenticated %}
            showLoginPrompt();
            return;
            {% endif %}
            
            isSubscribed = !isSubscribed;
            
            if (isSubscribed) {
                this.textContent = 'Вы подписаны';
                this.classList.add('subscribed');
                this.animate([
                    { transform: 'scale(0.9)', backgroundColor: 'var(--accent-color)' },
                    { transform: 'scale(1.1)', backgroundColor: '#333' },
                    { transform: 'scale(1)', backgroundColor: '#333' }
                ], {
                    duration: 300,
                    easing: 'ease-out',
                    fill: 'forwards'
                });
            } else {
                this.textContent = 'Подписаться';
                this.classList.remove('subscribed');
                this.animate([
                    { transform: 'scale(0.9)', backgroundColor: '#333' },
                    { transform: 'scale(1.1)', backgroundColor: 'var(--accent-color)' },
                    { transform: 'scale(1)', backgroundColor: 'var(--accent-color)' }
                ], {
                    duration: 300,
                    easing: 'ease-out',
                    fill: 'forwards'
                });
            }
            
            console.log(`User ${isSubscribed ? 'subscribed to' : 'unsubscribed from'} channel ${video.user_id}`);
        });
    }

    videoPlayer.addEventListener('play', function() {
        if (!watchStartTime) {
            watchStartTime = Date.now();
            console.log('Video playback started');
        }
    });

    videoPlayer.addEventListener('timeupdate', function() {
        if (!viewTracked && watchStartTime) {
            const elapsedTime = (Date.now() - watchStartTime) / 1000;
            if (elapsedTime >= 3) {
                trackView();
                console.log('3 seconds watched, tracking view');
            }
        }
    });

    videoPlayer.addEventListener('pause', function() {
        console.log('Video paused');
    });

    videoPlayer.addEventListener('ended', function() {
        console.log('Video ended');
    });

    const subscribeBtn = document.querySelector('.subscribe-button');
    const unsubscribeDialog = document.getElementById('unsubscribe-dialog');
    const confirmUnsubscribeBtn = document.getElementById('confirm-unsubscribe');
    const cancelUnsubscribeBtn = document.getElementById('cancel-unsubscribe');
    const unsubscribeChannelName = document.getElementById('unsubscribe-channel-name');
    const subscriberCountElem = document.getElementById('subscriber-count');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (subscribeBtn && !subscribeBtn.getAttribute('onclick')) {
        const channelId = subscribeBtn.getAttribute('data-channel-id');
        let isSubscribed = false;
        
        fetch(`/api/check-subscription/${channelId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isSubscribed = data.is_subscribed;
                    updateSubscribeButton(isSubscribed);
                    if (subscriberCountElem && data.subscriber_count !== undefined) {
                        subscriberCountElem.textContent = data.subscriber_count;
                    }
                }
            })
            .catch(error => {
                console.error('Error checking subscription:', error);
            });
        
        subscribeBtn.addEventListener('click', function() {
            if (isSubscribed) {
                unsubscribeDialog.classList.add('active');
                unsubscribeChannelName.textContent = "{{ video.display_name|default:video.channel }}";
            } else {
                toggleSubscription('subscribe');
            }
        });
        
        if (confirmUnsubscribeBtn) {
            confirmUnsubscribeBtn.addEventListener('click', function() {
                toggleSubscription('unsubscribe');
                unsubscribeDialog.classList.remove('active');
            });
        }
        
        if (cancelUnsubscribeBtn) {
            cancelUnsubscribeBtn.addEventListener('click', function() {
                unsubscribeDialog.classList.remove('active');
            });
        }
        
        if (unsubscribeDialog) {
            unsubscribeDialog.addEventListener('click', function(e) {
                if (e.target === unsubscribeDialog) {
                    unsubscribeDialog.classList.remove('active');
                }
            });
        }
        
        function toggleSubscription(action) {
            const formData = new FormData();
            formData.append('channel_id', channelId);
            formData.append('action', action);
            
            fetch('/api/toggle-subscription/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isSubscribed = data.is_subscribed;
                    updateSubscribeButton(isSubscribed);
                    if (subscriberCountElem && data.subscriber_count !== undefined) {
                        subscriberCountElem.textContent = data.subscriber_count;
                    }
                }
            })
            .catch(error => {
                console.error('Error toggling subscription:', error);
            });
        }
        
        function updateSubscribeButton(isSubscribed) {
            if (isSubscribed) {
                subscribeBtn.textContent = 'Вы подписаны';
                subscribeBtn.classList.add('subscribed');
            } else {
                subscribeBtn.textContent = 'Подписаться';
                subscribeBtn.classList.remove('subscribed');
            }
        }
    }

    function loadCommentAvatars() {
        const avatarPlaceholders = document.querySelectorAll('.qa-item .avatar .avatar-text, .qa-reply .avatar .avatar-text');
        
        avatarPlaceholders.forEach(placeholder => {
            const commentElement = placeholder.closest('.qa-item') || placeholder.closest('.qa-reply');
            const userId = commentElement.getAttribute('data-user-id');
            
            if (userId) {
                // Try to get avatar URL from user profile
                fetch(`/api/get-user-profile/?user_id=${encodeURIComponent(userId)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.profile && data.profile.avatar_url) {
                            // Replace placeholder with actual image
                            const avatarContainer = placeholder.parentElement;
                            const img = document.createElement('img');
                            img.src = data.profile.avatar_url;
                            img.alt = commentElement.querySelector('.qa-author').textContent.trim();
                            img.loading = "lazy";
                            
                            // Remove placeholder and add image
                            placeholder.remove();
                            avatarContainer.appendChild(img);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading comment avatar:', error);
                    });
            }
        });
    }
    
    // Call the function after page load
    setTimeout(loadCommentAvatars, 100);
    
    // Enhanced version of createCommentElement function
    function createCommentElement(comment) {
        const isAuthor = comment.user_id === videoUserId;
        
        const div = document.createElement('div');
        div.className = 'qa-item';
        div.setAttribute('data-comment-id', comment.id);
        div.setAttribute('data-user-id', comment.user_id);
        
        const displayName = comment.display_name || 'User';
        const firstLetter = displayName.charAt(0);
        
        // Format date in a user-friendly way
        const date = new Date(comment.date);
        const formattedDate = formatDate(date);
        
        // Determine avatar content - either image or first letter
        let avatarContent = '';
        if (comment.avatar_url) {
            avatarContent = `<img src="${comment.avatar_url}" alt="${displayName}">`;
        } else {
            avatarContent = `<span class="avatar-text">${firstLetter}</span>`;
            
            // Set a timer to try and load the actual avatar
            setTimeout(() => {
                fetch(`/api/get-user-profile/?user_id=${encodeURIComponent(comment.user_id)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.profile && data.profile.avatar_url) {
                            const avatarContainer = div.querySelector('.avatar');
                            if (avatarContainer) {
                                avatarContainer.innerHTML = `<img src="${data.profile.avatar_url}" alt="${displayName}">`;
                            }
                        }
                    })
                    .catch(err => console.error('Error loading avatar for new comment:', err));
            }, 200);
        }
        
        // Get current user initial for reply form
        const currentUserInitial = getCurrentUserInitial();
        // Get current user avatar for reply form
        const currentUserAvatar = getCurrentUserAvatar();
        
        div.innerHTML = `
            <div class="avatar ${isAuthor ? 'author-avatar' : ''}">
                ${avatarContent}
            </div>
            <div class="qa-content">
                <div class="qa-author ${isAuthor ? 'is-author' : ''}" data-username="${username}">
                    ${displayName}
                    ${isAuthor ? '<span class="author-badge">Автор</span>' : ''}
                </div>
                <div class="qa-text">${replyText}</div>
                <div class="qa-meta">${formattedDate}</div>
                <div class="qa-actions">
                    <button class="qa-like" data-liked="false"><img src="/static/icons/like.svg" alt="Like" width="20" height="20"> <span>${reply.likes || 0}</span></button>
                    <button class="qa-reply-to-reply-btn" data-comment-id="${parentCommentId || ''}" data-username="${username}">Ответить</button>
                </div>
            </div>
        `;
        
        return div;
    }

    // Helper function to get current user avatar HTML
    function getCurrentUserAvatar() {
        // Check if there's a current user avatar in the page
        const commentForm = document.getElementById('qa-form');
        if (commentForm) {
            const avatarContainer = commentForm.querySelector('.avatar');
            if (avatarContainer) {
                return avatarContainer.innerHTML;
            }
        }
        
        // Fallback to initial
        return '<span class="avatar-text">A</span>';
    }

    // Helper function to get current user initial
    function getCurrentUserInitial() {
        const commentForm = document.getElementById('qa-form');
        if (commentForm) {
            const avatarText = commentForm.querySelector('.avatar-text');
            if (avatarText) {
                return avatarText.textContent;
            }
        }
        return 'A';
    }
    
    // Load channel avatar if not already loaded
    function loadChannelAvatar() {
        const channelAvatar = document.querySelector('.channel-info .avatar');
        if (channelAvatar && !channelAvatar.querySelector('img')) {
            const videoContainer = document.querySelector('.video-container');
            if (videoContainer) {
                const userId = videoContainer.getAttribute('data-user-id');
                if (userId) {
                    fetch(`/api/get-user-profile/?user_id=${encodeURIComponent(userId)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.profile && data.profile.avatar_url) {
                                channelAvatar.innerHTML = `<img src="${data.profile.avatar_url}" alt="${data.profile.display_name || userId}" loading="lazy">`;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading channel avatar:', error);
                        });
                }
            }
        }
    }
    
    // Call the function to load channel avatar
    loadChannelAvatar();
    
    // Load related videos avatars
    function loadRelatedAvatars() {
        const relatedVideos = document.querySelectorAll('.related-video-card');
        relatedVideos.forEach(video => {
            const channelNameElement = video.querySelector('.related-channel');
            if (channelNameElement) {
                // Extract user ID from the card's onclick handler
                const onclickValue = video.getAttribute('onclick') || '';
                const match = onclickValue.match(/\/video\/([^\/]+)__/);
                if (match && match[1]) {
                    const userId = match[1];
                    
                    // Try to load avatar
                    fetch(`/api/get-user-profile/?user_id=${encodeURIComponent(userId)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.profile && data.profile.avatar_url) {
                                // Check if there's already an avatar container
                                let avatarContainer = video.querySelector('.related-avatar');
                                if (!avatarContainer) {
                                    // Create avatar container if it doesn't exist
                                    avatarContainer = document.createElement('div');
                                    avatarContainer.className = 'related-avatar';
                                    channelNameElement.parentNode.insertBefore(avatarContainer, channelNameElement);
                                }
                                
                                avatarContainer.innerHTML = `<img src="${data.profile.avatar_url}" alt="${data.profile.display_name || userId}" width="20" height="20" loading="lazy">`;
                                
                                // Add avatar style
                                const style = document.createElement('style');
                                style.textContent = `
                                    .related-avatar {
                                        width: 20px;
                                        height: 20px;
                                        border-radius: 50%;
                                        overflow: hidden;
                                        margin-right: 8px;
                                        display: inline-flex;
                                        vertical-align: middle;
                                    }
                                    .related-avatar img {
                                        width: 100%;
                                        height: 100%;
                                        object-fit: cover;
                                    }
                                `;
                                document.head.appendChild(style);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading related video avatar:', error);
                        });
                }
            }
        });
    }
    
    // Call the function to load related videos avatars
    setTimeout(loadRelatedAvatars, 300);
});
</script>
{% endblock %}